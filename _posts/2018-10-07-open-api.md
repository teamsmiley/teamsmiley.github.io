---
layout: post
title: 'Open API(Swagger)' 
author: teamsmiley
date: 2018-10-07
tags: [devops]
image: /files/covers/blog.jpg
category: {c#}
---

# dotnet core 2.1 에서 Open API(Swagger) 사용하기

## install nuget package 

```
Package Manager : Install-Package Swashbuckle.AspNetCore
CLI : dotnet add package Swashbuckle.AspNetCore
```

## wire up on startup 

두곳에 추가해 준다. 

```cs
public void ConfigureServices(IServiceCollection services)
{
  services.AddSwaggerGen(c =>
  {
      c.SwaggerDoc("v1", new Info { Title = "rendering farm", Version = "v1" });
  });
...

public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
...

  app.UseSwagger();

  app.UseSwaggerUI(c =>
  {
      c.SwaggerEndpoint("/swagger/v1/swagger.json", "Rendercore API V1");
  });

  app.UseMvc();
}
```

## Response content type 에 custom media type이 나오게 하기 

컨트롤러 하나에 ProducesResponseType를 넣는다. 버그인지는 모르겠으나 모든 컨트롤러중에 최소한 하나에 한번만 들어가도 swagger웹사이트에서 Response content type에서 필요한 모든 content type이 선택이 가능하게 된다.

```cs
...
[ProducesResponseType(typeof(RendererDto), 200)] //<== 이부분
public async Task<IActionResult> Get(Guid id)
{
   ...
    return Ok(item));
}
```

![]({{ site.baseurl }}/assets/custom-media-type.png)


## API Controller 

* 모든 controller에서 리턴 가능한 모든 케이스에 대해 ProducesResponseType을 붙여주자. 

```cs
[ProducesResponseType(typeof(RendererDto), 200)]
[ProducesResponseType(404)]
[ProducesResponseType(400)]
```

* Accept , Content-Type header값을 기본 선택해주기 위해 다음 코드중 필요한 부분을 컨트롤러 함수 위에 적어준다. 
```cs
[Consumes("application/vnd.rf.renderer.update+json")] // Post Put 에서 사용
[Produces("application/vnd.rf.renderer+json")] // Get에서 사용
```

이제 실행해보면 기본적으로 필요한 custom media type이 선택이 되잇는걸 볼수 있다. 

## NSwagStudio를 이용하여 클라이언트 코드를 만들어보자.

npm install -g nswag

* NSwagStudio 설치 

https://github.com/RSuter/NSwag/wiki/NSwagStudio

* 


* 설치 업데이트 롤백

```bash
# Install latest autorest package
npm install -g autorest

# Update the generator plugins to the latest stable version
autorest --reset

# install the latest nightly autorest generators 
autorest --latest --prerelease 

# revert back to the latest stable release of autorest generators:
autorest --reset
```

* Generate Client Code

```bash
cd /c/temp

# download json
curl -O https://localhost:44328/swagger/v1/swagger.json -k

# swagger.json을 확인한다.
ls

# generate code CS
autorest \
--namespace=Clients.DataService \
--input-file=swagger.json \
--output-folder=Clients.DataService \
--csharp

# generate code TypeScript
autorest \
--namespace=Clients.DataService \
--input-file=swagger.json \
--output-folder=Clients.DataService \
--typescript

```




